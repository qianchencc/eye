#!/bin/bash

# =================é…ç½®ä¸è·¯å¾„å®šä¹‰ (XDGå‡†åˆ™)=================
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/eye"
DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/eye"
STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/eye"

CONFIG_FILE="$CONFIG_DIR/config"
CUSTOM_SOUNDS_MAP="$CONFIG_DIR/custom_sounds.map"
EYE_LOG="$STATE_DIR/last_notified"
PID_FILE="$STATE_DIR/daemon.pid"
PAUSE_FILE="$STATE_DIR/pause_until"

# ç¡®ä¿ç›®å½•å­˜åœ¨
mkdir -p "$CONFIG_DIR" "$DATA_DIR/sounds" "$STATE_DIR"

# é»˜è®¤é…ç½®
DEFAULT_REST_GAP=1200
DEFAULT_LOOK_AWAY=20
DEFAULT_SOUND_START="default"
DEFAULT_SOUND_END="complete"
DEFAULT_SOUND_SWITCH="on"
DEFAULT_LANGUAGE="en"

# =================å¤šè¯­è¨€æ”¯æŒ (Centralized Messages)=================
_init_messages() {
    # ä¼˜å…ˆä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„ LANGUAGEï¼Œå¦‚æœæœªè®¾ç½®åˆ™å›é€€åˆ°ç³»ç»Ÿ LANGï¼Œæœ€åé»˜è®¤ en
    if [[ "$LANGUAGE" == "zh" ]] || [[ "$LANGUAGE" == "Chinese" ]]; then
        LANG_MODE="zh"
    elif [[ "$LANGUAGE" == "en" ]] || [[ "$LANGUAGE" == "English" ]]; then
        LANG_MODE="en"
    elif [[ -z "$LANGUAGE" ]]; then
        # åªæœ‰åœ¨æœªé…ç½®æ—¶æ‰æ£€æµ‹ç³»ç»Ÿè¯­è¨€
        if [[ "$LANG" == zh* ]]; then
            LANG_MODE="zh"
        else
            LANG_MODE="en"
        fi
    else
        LANG_MODE="en"
    fi

    if [ "$LANG_MODE" == "zh" ]; then
        MSG_USAGE_HEADER="ç”¨æ³•: eye <command> [args]"
        MSG_USAGE_CORE="æ ¸å¿ƒå‘½ä»¤:"
        MSG_USAGE_CMD_START="  start            å¯åŠ¨æŠ¤çœ¼åå°è¿›ç¨‹"
        MSG_USAGE_CMD_STOP="  stop             åœæ­¢æŠ¤çœ¼è¿›ç¨‹"
        MSG_USAGE_CMD_PAUSE="  pause <time>     æš‚åœæŠ¤çœ¼æ¨¡å¼æŒ‡å®šæ—¶é•¿ (ä¾‹å¦‚: 1h, 30m, 1h30m)"
        MSG_USAGE_CMD_RESUME="  resume           å–æ¶ˆæš‚åœï¼Œç«‹å³æ¢å¤"
        MSG_USAGE_CMD_STATUS="  status           æŸ¥çœ‹å½“å‰çŠ¶æ€"
        MSG_USAGE_CMD_NOW="  now              ç«‹å³æ‰§è¡Œä¸€æ¬¡æŠ¤çœ¼æé†’"
        MSG_USAGE_CMD_SET="  set <gap> <look> è®¾ç½®æ—¶é—´é—´éš”å’Œè¿œçœºæ—¶é•¿ (æ”¯æŒå•ä½ s, m, h)\n                   ä¾‹å¦‚: eye set 20m 20s"
        MSG_USAGE_CMD_LANG="  language <lang>  è®¾ç½®è¯­è¨€ (English/Chinese)"
        MSG_USAGE_AUDIO="éŸ³é¢‘ç®¡ç† (eye sound ...):"
        MSG_USAGE_CMD_SOUND_LIST="  sound list              åˆ—å‡ºæ‰€æœ‰å¯ç”¨éŸ³æ•ˆ"
        MSG_USAGE_CMD_SOUND_PLAY="  sound play <tag>        è¯•å¬æŒ‡å®šæ ‡ç­¾çš„éŸ³æ•ˆ"
        MSG_USAGE_CMD_SOUND_SET="  sound set <start> <end> è®¾ç½®å¼€å§‹å’Œç»“æŸçš„æç¤ºéŸ³"
        MSG_USAGE_CMD_SOUND_ADD="  sound add <tag> <path>  æ·»åŠ è‡ªå®šä¹‰éŸ³é¢‘æ–‡ä»¶"
        MSG_USAGE_CMD_SOUND_RM="  sound rm  <tag>         åˆ é™¤è‡ªå®šä¹‰éŸ³æ•ˆ"
        MSG_USAGE_CMD_SOUND_SWITCH="  sound on|off            å…¨å±€å¼€å¯æˆ–å…³é—­å£°éŸ³"
        
        MSG_START_ALREADY_RUNNING="âš ï¸  æŠ¤çœ¼æ¨¡å¼å·²åœ¨è¿è¡Œä¸­ (PID: %s)"
        MSG_START_STARTED="âœ… æŠ¤çœ¼æ¨¡å¼å·²å¯åŠ¨"
        MSG_STOP_STOPPED="ğŸ›‘ å·²åœæ­¢"
        MSG_STOP_NOT_RUNNING="âš ï¸  æœªè¿è¡Œ"
        MSG_PAUSE_SPECIFY_DURATION="âŒ è¯·æŒ‡å®šæ—¶é•¿ (å¦‚ 1h, 30m)"
        MSG_PAUSE_PAUSED="â¸ï¸  æŠ¤çœ¼æ¨¡å¼æš‚åœ %s (ç›´åˆ° %s)"
        MSG_PAUSE_ERROR_FORMAT="âŒ æ ¼å¼é”™è¯¯ã€‚ç¤ºä¾‹: 1h, 30m, 10s"
        MSG_RESUME_RESUMED="â–¶ï¸  æš‚åœå·²å–æ¶ˆï¼Œæ¢å¤è¿è¡Œ"
        MSG_RESUME_NOT_PAUSED="âš ï¸  å½“å‰æœªå¤„äºæš‚åœçŠ¶æ€"
        MSG_NOW_TRIGGERING="ğŸ”„ æ­£åœ¨è§¦å‘è¿œçœº..."
        MSG_STATUS_RUNNING="ğŸŸ¢ è¿è¡Œä¸­ | PID: %s"
        MSG_STATUS_PAUSED_REMAINING="â¸ï¸  [å·²æš‚åœ] å‰©ä½™: %s (ç›´åˆ° %s)"
        MSG_STATUS_STOPPED="ğŸ”´ å·²åœæ­¢"
        MSG_STATUS_CONFIG="âš™ï¸  é…ç½®: %s é—´éš” / %s è¿œçœº"
        MSG_STATUS_LAST_REST="â±ï¸  ä¸Šæ¬¡ä¼‘æ¯: %s å‰"
        MSG_STATUS_SOUND="ğŸ”Š éŸ³æ•ˆ: [%s] -> [%s] (å¼€å…³: %s)"
        MSG_STATUS_LANG="ğŸŒ è¯­è¨€: %s"
        MSG_SET_USAGE_HINT="ç”¨æ³•: eye set <é—´éš”> <æ—¶é•¿>\nç¤ºä¾‹: eye set 20m 20s"
        MSG_SET_UPDATED="âœ… é…ç½®å·²æ›´æ–°: é—´éš” %s, è¿œçœº %s"
        MSG_LANG_UPDATED="âœ… è¯­è¨€å·²åˆ‡æ¢ä¸º: %s (Language switched to: %s)"
        MSG_LANG_INVALID="âŒ æ— æ•ˆçš„è¯­è¨€é€‰é¡¹ã€‚è¯·ä½¿ç”¨ 'English' æˆ– 'Chinese'ã€‚"
        
        MSG_SOUND_LIST_HEADER="ğŸµ å¯ç”¨éŸ³æ•ˆåˆ—è¡¨ï¼š"
        MSG_SOUND_LIST_BUILTIN="  [å†…ç½®] (ä¸å¯åˆ é™¤)"
        MSG_SOUND_LIST_CUSTOM="  [è‡ªå®šä¹‰]"
        MSG_SOUND_LIST_NONE="  (æ— )"
        MSG_SOUND_LIST_ITEM_NONE="  - none      : é™éŸ³"
        MSG_SOUND_LIST_ITEM_DEFAULT="  - default   : æ ‡å‡†é€šçŸ¥"
        MSG_SOUND_LIST_ITEM_BELL="  - bell      : æ¸…è„†é“ƒå£°"
        MSG_SOUND_LIST_ITEM_COMPLETE="  - complete  : ä»»åŠ¡å®Œæˆ"
        MSG_SOUND_LIST_ITEM_SUCCESS="  - success   : æˆåŠŸéŸ³"
        MSG_SOUND_LIST_ITEM_ALARM="  - alarm     : é—¹é’Ÿ"
        MSG_SOUND_LIST_ITEM_CAMERA="  - camera    : å¿«é—¨å£°"
        MSG_SOUND_LIST_ITEM_DEVICE="  - device    : è®¾å¤‡æ¥å…¥"
        MSG_SOUND_LIST_ITEM_ATTENTION="  - attention : æç¤ºéŸ³"
        
        MSG_SOUND_PLAY_TAG_REQUIRED="âŒ è¯·æŒ‡å®šæ ‡ç­¾"
        MSG_SOUND_PLAY_PLAYING="â–¶ï¸  è¯•å¬ [%s] : %s"
        MSG_SOUND_PLAY_MUTE="ğŸ”‡ (é™éŸ³)"
        MSG_SOUND_PLAY_ERROR="âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•æ’­æ”¾"
        MSG_SOUND_SET_UPDATED="âœ… éŸ³æ•ˆå·²æ›´æ–°: å¼€å§‹[%s] -> ç»“æŸ[%s]"
        MSG_SOUND_ADD_USAGE="âŒ ç”¨æ³•: eye sound add <tag> <path>"
        MSG_SOUND_ADD_ERROR_BUILTIN="âŒ é”™è¯¯: '%s' æ˜¯å†…ç½®éŸ³æ•ˆï¼Œæ— æ³•è¦†ç›–ã€‚"
        MSG_SOUND_ADD_ERROR_FILE="âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: %s"
        MSG_SOUND_ADD_CONFIRM_REPLACE="âš ï¸  æ ‡ç­¾ '%s' å·²å­˜åœ¨ï¼Œæ˜¯å¦æ›¿æ¢ï¼Ÿ[y/N] "
        MSG_SOUND_ADD_ADDED="âœ… å·²æ·»åŠ : %s"
        MSG_SOUND_RM_USAGE="âŒ ç”¨æ³•: eye sound rm <tag>"
        MSG_SOUND_RM_ERROR_BUILTIN="âŒ é”™è¯¯: '%s' æ˜¯å†…ç½®éŸ³æ•ˆï¼Œä¸èƒ½åˆ é™¤ã€‚"
        MSG_SOUND_RM_DELETED="ğŸ—‘ï¸  å·²åˆ é™¤éŸ³æ•ˆ: %s"
        MSG_SOUND_RM_NOT_FOUND="âš ï¸  æœªæ‰¾åˆ°è‡ªå®šä¹‰æ ‡ç­¾: %s"
        MSG_SOUND_RM_NO_CUSTOM="âš ï¸  æš‚æ— è‡ªå®šä¹‰é…ç½®"
        MSG_SOUND_ON="ğŸ”Š å£°éŸ³å·²å¼€å¯"
        MSG_SOUND_OFF="ğŸ”‡ å£°éŸ³å·²å…³é—­"
        MSG_SOUND_USAGE="ç”¨æ³•: eye sound [list|play|set|add|rm|on|off]"
        
        MSG_NOTIFY_TITLE_START="ğŸ‘€ æŠ¤çœ¼æ—¶é—´"
        MSG_NOTIFY_BODY_START="å¼€å§‹è¿œçœº %sï¼"
        MSG_NOTIFY_TITLE_END="âœ… è¿œçœºç»“æŸ"
        MSG_NOTIFY_BODY_END="çœ¼ç›ä¼‘æ¯å¥½äº†ï¼Œç»§ç»­åŠ æ²¹å§ï¼"
        MSG_ERROR_INVALID_TIME_FORMAT="é”™è¯¯: æ— æ•ˆçš„æ—¶é—´æ ¼å¼"
        
    else
        # English
        MSG_USAGE_HEADER="Usage: eye <command> [args]"
        MSG_USAGE_CORE="Core Commands:"
        MSG_USAGE_CMD_START="  start            Start the eye protection daemon"
        MSG_USAGE_CMD_STOP="  stop             Stop the eye protection daemon"
        MSG_USAGE_CMD_PAUSE="  pause <time>     Pause for a specific duration (e.g., 1h, 30m, 1h30m)"
        MSG_USAGE_CMD_RESUME="  resume           Resume from pause immediately"
        MSG_USAGE_CMD_STATUS="  status           Show current status"
        MSG_USAGE_CMD_NOW="  now              Trigger an eye break immediately"
        MSG_USAGE_CMD_SET="  set <gap> <look> Set interval and look-away duration (units: s, m, h)\n                   Example: eye set 20m 20s"
        MSG_USAGE_CMD_LANG="  language <lang>  Set language (English/Chinese)"
        MSG_USAGE_AUDIO="Audio Management (eye sound ...):"
        MSG_USAGE_CMD_SOUND_LIST="  sound list              List all available sounds"
        MSG_USAGE_CMD_SOUND_PLAY="  sound play <tag>        Preview a specific sound"
        MSG_USAGE_CMD_SOUND_SET="  sound set <start> <end> Set start and end sounds"
        MSG_USAGE_CMD_SOUND_ADD="  sound add <tag> <path>  Add a custom audio file"
        MSG_USAGE_CMD_SOUND_RM="  sound rm  <tag>         Remove a custom sound"
        MSG_USAGE_CMD_SOUND_SWITCH="  sound on|off            Turn sound on or off globally"
        
        MSG_START_ALREADY_RUNNING="âš ï¸  Eye protection mode is already running (PID: %s)"
        MSG_START_STARTED="âœ… Eye protection mode started"
        MSG_STOP_STOPPED="ğŸ›‘ Stopped"
        MSG_STOP_NOT_RUNNING="âš ï¸  Not running"
        MSG_PAUSE_SPECIFY_DURATION="âŒ Please specify duration (e.g., 1h, 30m)"
        MSG_PAUSE_PAUSED="â¸ï¸  Eye protection paused for %s (until %s)"
        MSG_PAUSE_ERROR_FORMAT="âŒ Invalid format. Example: 1h, 30m, 10s"
        MSG_RESUME_RESUMED="â–¶ï¸  Pause cancelled, resumed"
        MSG_RESUME_NOT_PAUSED="âš ï¸  Not currently paused"
        MSG_NOW_TRIGGERING="ğŸ”„ Triggering look-away..."
        MSG_STATUS_RUNNING="ğŸŸ¢ Running | PID: %s"
        MSG_STATUS_PAUSED_REMAINING="â¸ï¸  [Paused] Remaining: %s (until %s)"
        MSG_STATUS_STOPPED="ğŸ”´ Stopped"
        MSG_STATUS_CONFIG="âš™ï¸  Config: %s gap / %s look-away"
        MSG_STATUS_LAST_REST="â±ï¸  Last rest: %s ago"
        MSG_STATUS_SOUND="ğŸ”Š Sound: [%s] -> [%s] (Switch: %s)"
        MSG_STATUS_LANG="ğŸŒ Language: %s"
        MSG_SET_USAGE_HINT="Usage: eye set <gap> <look>\nExample: eye set 20m 20s"
        MSG_SET_UPDATED="âœ… Config updated: Gap %s, Look-away %s"
        MSG_LANG_UPDATED="âœ… Language switched to: %s"
        MSG_LANG_INVALID="âŒ Invalid language option. Please use 'English' or 'Chinese'."
        
        MSG_SOUND_LIST_HEADER="ğŸµ Available Sounds:"
        MSG_SOUND_LIST_BUILTIN="  [Built-in] (Cannot be removed)"
        MSG_SOUND_LIST_CUSTOM="  [Custom]"
        MSG_SOUND_LIST_NONE="  (None)"
        MSG_SOUND_LIST_ITEM_NONE="  - none      : Mute"
        MSG_SOUND_LIST_ITEM_DEFAULT="  - default   : Standard message"
        MSG_SOUND_LIST_ITEM_BELL="  - bell      : Bell"
        MSG_SOUND_LIST_ITEM_COMPLETE="  - complete  : Task complete"
        MSG_SOUND_LIST_ITEM_SUCCESS="  - success   : Success"
        MSG_SOUND_LIST_ITEM_ALARM="  - alarm     : Alarm clock"
        MSG_SOUND_LIST_ITEM_CAMERA="  - camera    : Camera shutter"
        MSG_SOUND_LIST_ITEM_DEVICE="  - device    : Device added"
        MSG_SOUND_LIST_ITEM_ATTENTION="  - attention : Attention"
        
        MSG_SOUND_PLAY_TAG_REQUIRED="âŒ Please specify a tag"
        MSG_SOUND_PLAY_PLAYING="â–¶ï¸  Previewing [%s] : %s"
        MSG_SOUND_PLAY_MUTE="ğŸ”‡ (Muted)"
        MSG_SOUND_PLAY_ERROR="âŒ File not found or cannot play"
        MSG_SOUND_SET_UPDATED="âœ… Sounds updated: Start[%s] -> End[%s]"
        MSG_SOUND_ADD_USAGE="âŒ Usage: eye sound add <tag> <path>"
        MSG_SOUND_ADD_ERROR_BUILTIN="âŒ Error: '%s' is a built-in sound, cannot overwrite."
        MSG_SOUND_ADD_ERROR_FILE="âŒ Error: File not found: %s"
        MSG_SOUND_ADD_CONFIRM_REPLACE="âš ï¸  Tag '%s' already exists, replace? [y/N] "
        MSG_SOUND_ADD_ADDED="âœ… Added: %s"
        MSG_SOUND_RM_USAGE="âŒ Usage: eye sound rm <tag>"
        MSG_SOUND_RM_ERROR_BUILTIN="âŒ Error: '%s' is a built-in sound, cannot remove."
        MSG_SOUND_RM_DELETED="ğŸ—‘ï¸  Deleted sound: %s"
        MSG_SOUND_RM_NOT_FOUND="âš ï¸  Custom tag not found: %s"
        MSG_SOUND_RM_NO_CUSTOM="âš ï¸  No custom configuration"
        MSG_SOUND_ON="ğŸ”Š Sound enabled"
        MSG_SOUND_OFF="ğŸ”‡ Sound disabled"
        MSG_SOUND_USAGE="Usage: eye sound [list|play|set|add|rm|on|off]"
        
        MSG_NOTIFY_TITLE_START="ğŸ‘€ Eye Protection"
        MSG_NOTIFY_BODY_START="Look away for %s!"
        MSG_NOTIFY_TITLE_END="âœ… Break Ended"
        MSG_NOTIFY_BODY_END="Eyes rested. Keep going!"
        MSG_ERROR_INVALID_TIME_FORMAT="Error: Invalid time format"
    fi
}

# =================æ ¸å¿ƒåŠŸèƒ½å‡½æ•°=================

# æ—¶é—´è§£æå‡½æ•° (æ”¯æŒ 1h 30m 20s æ ¼å¼)
_parse_duration() {
    local input="$*"
    # ç§»é™¤æ‰€æœ‰ç©ºæ ¼
    input="${input// /}"
    
    # å¦‚æœæ˜¯çº¯æ•°å­—ï¼Œé»˜è®¤ä¸ºç§’
    if [[ "$input" =~ ^[0-9]+$ ]]; then
        echo "$input"
        return
    fi

    local total_seconds=0
    
    # æå–å¤© (d)
    if [[ "$input" =~ ([0-9]+)d ]]; then
        total_seconds=$((total_seconds + ${BASH_REMATCH[1]} * 86400))
    fi
    # æå–å°æ—¶ (h)
    if [[ "$input" =~ ([0-9]+)h ]]; then
        total_seconds=$((total_seconds + ${BASH_REMATCH[1]} * 3600))
    fi
    # æå–åˆ†é’Ÿ (m)
    if [[ "$input" =~ ([0-9]+)m ]]; then
        total_seconds=$((total_seconds + ${BASH_REMATCH[1]} * 60))
    fi
    # æå–ç§’ (s)
    if [[ "$input" =~ ([0-9]+)s ]]; then
        total_seconds=$((total_seconds + ${BASH_REMATCH[1]}))
    fi

    if [ "$total_seconds" -eq 0 ]; then
        echo "$MSG_ERROR_INVALID_TIME_FORMAT" >&2
        return 1
    fi
    
    echo "$total_seconds"
}

# æ ¼å¼åŒ–ç§’æ•°ä¸ºæ˜“è¯»æ ¼å¼
_format_duration() {
    local T=$1
    local D=$((T/60/60/24))
    local H=$((T/60/60%24))
    local M=$((T/60%60))
    local S=$((T%60))
    
    [[ $D -gt 0 ]] && printf '%dd ' $D
    [[ $H -gt 0 ]] && printf '%dh ' $H
    [[ $M -gt 0 ]] && printf '%dm ' $M
    [[ $D -eq 0 && $H -eq 0 && $M -eq 0 ]] && printf '%ds' $S || printf '%ds' $S
}

# åŠ è½½é…ç½®
_load_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        cat > "$CONFIG_FILE" <<EOF
REST_GAP=$DEFAULT_REST_GAP
LOOK_AWAY=$DEFAULT_LOOK_AWAY
SOUND_START=$DEFAULT_SOUND_START
SOUND_END=$DEFAULT_SOUND_END
SOUND_SWITCH=$DEFAULT_SOUND_SWITCH
LANGUAGE=$DEFAULT_LANGUAGE
EOF
    fi
    source "$CONFIG_FILE"
    
    # ç¡®ä¿å˜é‡æœ‰é»˜è®¤å€¼ (é˜²æ­¢æ—§é…ç½®æ–‡ä»¶ç¼ºå¤±æ–°å˜é‡)
    REST_GAP=${REST_GAP:-$DEFAULT_REST_GAP}
    LOOK_AWAY=${LOOK_AWAY:-$DEFAULT_LOOK_AWAY}
    SOUND_START=${SOUND_START:-$DEFAULT_SOUND_START}
    SOUND_END=${SOUND_END:-$DEFAULT_SOUND_END}
    SOUND_SWITCH=${SOUND_SWITCH:-$DEFAULT_SOUND_SWITCH}
    LANGUAGE=${LANGUAGE:-$DEFAULT_LANGUAGE}

    [ -f "$CUSTOM_SOUNDS_MAP" ] && source "$CUSTOM_SOUNDS_MAP"
}

# ä¿å­˜åŸºç¡€é…ç½®
_save_config() {
    cat > "$CONFIG_FILE" <<EOF
REST_GAP=${REST_GAP:-$DEFAULT_REST_GAP}
LOOK_AWAY=${LOOK_AWAY:-$DEFAULT_LOOK_AWAY}
SOUND_START=${SOUND_START:-$DEFAULT_SOUND_START}
SOUND_END=${SOUND_END:-$DEFAULT_SOUND_END}
SOUND_SWITCH=${SOUND_SWITCH:-$DEFAULT_SOUND_SWITCH}
LANGUAGE=${LANGUAGE:-$DEFAULT_LANGUAGE}
EOF
}

# è·å–éŸ³æ•ˆè·¯å¾„
_get_sound_path() {
    local tag=$1
    local path=""
    
    case "$tag" in
        "none")      echo "NONE"; return ;; 
        "default")   path="/usr/share/sounds/freedesktop/stereo/message.oga" ;; 
        "bell")      path="/usr/share/sounds/freedesktop/stereo/bell.oga" ;; 
        "complete")  path="/usr/share/sounds/freedesktop/stereo/complete.oga" ;; 
        "success")   path="/usr/share/sounds/freedesktop/stereo/service-login.oga" ;; 
        "alarm")     path="/usr/share/sounds/freedesktop/stereo/alarm-clock-elapsed.oga" ;; 
        "camera")    path="/usr/share/sounds/freedesktop/stereo/camera-shutter.oga" ;; 
        "device")    path="/usr/share/sounds/freedesktop/stereo/device-added.oga" ;; 
        "attention") path="/usr/share/sounds/freedesktop/stereo/window-attention.oga" ;; 
        *)
            local custom_var="SOUND_PATH_${tag}"
            path="${!custom_var}" 
            ;; 
    esac

    if [ ! -f "$path" ]; then
         path="/usr/share/sounds/freedesktop/stereo/message.oga"
    fi
    echo "$path"
}

_play() {
    [ "$SOUND_SWITCH" != "on" ] && return
    local tag=$1
    local file=$(_get_sound_path "$tag")
    
    if [ "$file" == "NONE" ]; then
        return
    elif [ -f "$file" ] && command -v paplay > /dev/null; then
        paplay "$file" > /dev/null 2>&1 &
    fi
}

_eye_action() {
    _load_config
    # æ³¨æ„ï¼šåå°è¿›ç¨‹çš„ç¯å¢ƒå˜é‡å¯èƒ½ä¸åŒï¼Œæ‰€ä»¥éœ€è¦åœ¨ action å†…éƒ¨é‡æ–°åˆå§‹åŒ–æ¶ˆæ¯ (æˆ–ç¡®ä¿ LANG ä¼ é€’)
    # è¿™é‡Œç®€å•èµ·è§å†æ¬¡è°ƒç”¨åˆå§‹åŒ–
    _init_messages
    
    local look_fmt=$(_format_duration ${LOOK_AWAY})
    # ä½¿ç”¨ printf æ ¼å¼åŒ–æ¶ˆæ¯
    local body_start=$(printf "$MSG_NOTIFY_BODY_START" "$look_fmt")
    
    notify-send -i appointment-soon -t 5000 "$MSG_NOTIFY_TITLE_START" "$body_start"
    _play "$SOUND_START"
    
    sleep "$LOOK_AWAY"
    
    notify-send -i emblem-success -t 3000 "$MSG_NOTIFY_TITLE_END" "$MSG_NOTIFY_BODY_END"
    _play "$SOUND_END"
    
    date +%s > "$EYE_LOG"
}

# =================å‘½ä»¤å¤„ç†é€»è¾‘=================

_usage() {
    # è¿™é‡Œçš„æ‰“å°é€»è¾‘ä¹Ÿè¦è°ƒæ•´
    echo "$MSG_USAGE_HEADER"
    echo ""
    echo "$MSG_USAGE_CORE"
    echo "$MSG_USAGE_CMD_START"
    echo "$MSG_USAGE_CMD_STOP"
    echo "$MSG_USAGE_CMD_PAUSE"
    echo "$MSG_USAGE_CMD_RESUME"
    echo "$MSG_USAGE_CMD_STATUS"
    echo "$MSG_USAGE_CMD_NOW"
    echo -e "$MSG_USAGE_CMD_SET"
    echo "$MSG_USAGE_CMD_LANG"
    echo ""
    echo "$MSG_USAGE_AUDIO"
    echo "$MSG_USAGE_CMD_SOUND_LIST"
    echo "$MSG_USAGE_CMD_SOUND_PLAY"
    echo "$MSG_USAGE_CMD_SOUND_SET"
    echo "$MSG_USAGE_CMD_SOUND_ADD"
    echo "$MSG_USAGE_CMD_SOUND_RM"
    echo "$MSG_USAGE_CMD_SOUND_SWITCH"
}

_cmd_sound() {
    local subcmd=$1
    shift
    _load_config

    case "$subcmd" in
        list)
            echo "$MSG_SOUND_LIST_HEADER"
            echo "$MSG_SOUND_LIST_BUILTIN"
            echo "$MSG_SOUND_LIST_ITEM_NONE"
            echo "$MSG_SOUND_LIST_ITEM_DEFAULT"
            echo "$MSG_SOUND_LIST_ITEM_BELL"
            echo "$MSG_SOUND_LIST_ITEM_COMPLETE"
            echo "$MSG_SOUND_LIST_ITEM_SUCCESS"
            echo "$MSG_SOUND_LIST_ITEM_ALARM"
            echo "$MSG_SOUND_LIST_ITEM_CAMERA"
            echo "$MSG_SOUND_LIST_ITEM_DEVICE"
            echo "$MSG_SOUND_LIST_ITEM_ATTENTION"
            
            echo ""
            echo "$MSG_SOUND_LIST_CUSTOM"
            local has_custom=0
            if [ -f "$CUSTOM_SOUNDS_MAP" ]; then
                while IFS='=' read -r key value; do
                    if [[ $key == SOUND_PATH_* ]]; then
                        tag=${key#SOUND_PATH_}
                        echo "  - $tag : $value"
                        has_custom=1
                    fi
                done < "$CUSTOM_SOUNDS_MAP"
            fi
            [ $has_custom -eq 0 ] && echo "$MSG_SOUND_LIST_NONE"
            ;; 
        play)
            local tag=$1
            [ -z "$tag" ] && { echo "$MSG_SOUND_PLAY_TAG_REQUIRED"; return 1; }
            local path=$(_get_sound_path "$tag")
            printf "$MSG_SOUND_PLAY_PLAYING\n" "$tag" "$path"
            if [ -f "$path" ]; then
                command -v paplay >/dev/null && paplay "$path"
            elif [ "$tag" == "none" ]; then
                echo "$MSG_SOUND_PLAY_MUTE"
            else
                echo "$MSG_SOUND_PLAY_ERROR"
            fi
            ;; 
        set)
            local s1=${1:-$SOUND_START}
            local s2=${2:-$SOUND_END}
            SOUND_START=$s1
            SOUND_END=$s2
            _save_config
            printf "$MSG_SOUND_SET_UPDATED\n" "$s1" "$s2"
            ;; 
        add)
            local tag=$1
            local path=$2
            if [ -z "$tag" ] || [ -z "$path" ]; then
                echo "$MSG_SOUND_ADD_USAGE"
                return 1
            fi
            if [[ " none default bell complete success alarm camera device attention " =~ " $tag " ]]; then
                 printf "$MSG_SOUND_ADD_ERROR_BUILTIN\n" "$tag"
                 return 1
            fi
            if [ ! -f "$path" ]; then
                printf "$MSG_SOUND_ADD_ERROR_FILE\n" "$path"
                return 1
            fi
            if grep -q "SOUND_PATH_${tag}=" "$CUSTOM_SOUNDS_MAP" 2>/dev/null; then
                # printf "$MSG_SOUND_ADD_CONFIRM_REPLACE" "$tag"
                # read -p can't easily use variable for prompt if it has %s, so print first
                printf "$MSG_SOUND_ADD_CONFIRM_REPLACE" "$tag"
                read choice
                [[ "$choice" != "y" && "$choice" != "Y" ]] && return
            fi
            local abs_path=$(readlink -f "$path")
            [ -f "$CUSTOM_SOUNDS_MAP" ] && sed -i "/SOUND_PATH_${tag}=/d" "$CUSTOM_SOUNDS_MAP"
            echo "SOUND_PATH_${tag}=\"${abs_path}\"" >> "$CUSTOM_SOUNDS_MAP"
            printf "$MSG_SOUND_ADD_ADDED\n" "$tag"
            ;; 
        rm)
            local tag=$1
            if [ -z "$tag" ]; then
                echo "$MSG_SOUND_RM_USAGE"
                return 1
            fi
            if [[ " none default bell complete success alarm camera device attention " =~ " $tag " ]]; then
                 printf "$MSG_SOUND_RM_ERROR_BUILTIN\n" "$tag"
                 return 1
            fi
            if [ -f "$CUSTOM_SOUNDS_MAP" ]; then
                if grep -q "SOUND_PATH_${tag}=" "$CUSTOM_SOUNDS_MAP"; then
                    sed -i "/SOUND_PATH_${tag}=/d" "$CUSTOM_SOUNDS_MAP"
                    printf "$MSG_SOUND_RM_DELETED\n" "$tag"
                else
                    printf "$MSG_SOUND_RM_NOT_FOUND\n" "$tag"
                fi
            else
                echo "$MSG_SOUND_RM_NO_CUSTOM"
            fi
            ;; 
        on)
            SOUND_SWITCH="on"; _save_config; echo "$MSG_SOUND_ON" ;; 
        off)
            SOUND_SWITCH="off"; _save_config; echo "$MSG_SOUND_OFF" ;; 
        *)
            echo "$MSG_SOUND_USAGE" ;; 
    esac
}
# =================ä¸»ç¨‹åºå…¥å£=================

# å¿…é¡»å…ˆåŠ è½½é…ç½®æ‰èƒ½è·å– LANGUAGE å˜é‡
_load_config
# åˆå§‹åŒ–è¯­è¨€
_init_messages

# å¤„ç† --help
if [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]] || [[ -z "$1" ]]; then
    _usage
    exit 0
fi

case "$1" in
    start)
        if [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null; then
            printf "$MSG_START_ALREADY_RUNNING\n" "$(cat "$PID_FILE")"
        else
            (
                echo $BASHPID > "$PID_FILE"
                date +%s > "$EYE_LOG"
                while true; do
                    _load_config
                    # å®ˆæŠ¤è¿›ç¨‹ä¸­æ¯æ¬¡å¾ªç¯éƒ½åˆå§‹åŒ–ä¸€ä¸‹æ¶ˆæ¯ï¼Œä»¥é˜²ä¸‡ä¸€ï¼ˆè™½ç„¶é€šå¸¸ä¸éœ€è¦ï¼Œä½†ä¸ºäº† safetyï¼‰
                    _init_messages
                    
                    current_time=$(date +%s)
                    
                    # æ£€æŸ¥æ˜¯å¦æš‚åœ
                    if [ -f "$PAUSE_FILE" ]; then
                        pause_until=$(cat "$PAUSE_FILE")
                        if [ "$current_time" -lt "$pause_until" ]; then
                             sleep 5
                             continue
                        else
                             rm "$PAUSE_FILE" # æš‚åœè¿‡æœŸ
                        fi
                    fi

                    last_time=$(cat "$EYE_LOG" 2>/dev/null || date +%s)
                    if [ $((current_time - last_time)) -ge $REST_GAP ]; then
                         _eye_action & 
                         wait $!
                    fi
                    sleep 5
                done
            ) > /dev/null 2>&1 &
            disown
            echo "$MSG_START_STARTED"
        fi
        ;; 
    stop)
        if [ -f "$PID_FILE" ]; then
            pkill -P $(cat "$PID_FILE") >/dev/null 2>&1
            kill $(cat "$PID_FILE") >/dev/null 2>&1
            rm "$PID_FILE" 2>/dev/null
            rm "$PAUSE_FILE" 2>/dev/null
            echo "$MSG_STOP_STOPPED"
        else
            echo "$MSG_STOP_NOT_RUNNING"
        fi
        ;; 
    pause)
        duration_str="$*"
        [ -z "$duration_str" ] && { echo "$MSG_PAUSE_SPECIFY_DURATION"; exit 1; }
        seconds=$(_parse_duration "$duration_str")
        if [ $? -eq 0 ]; then
            target_time=$(( $(date +%s) + seconds ))
            echo "$target_time" > "$PAUSE_FILE"
            formatted_dur=$(_format_duration "$seconds")
            target_date=$(date -d "@$target_time" "+%H:%M:%S")
            printf "$MSG_PAUSE_PAUSED\n" "$formatted_dur" "$target_date"
        else
             echo "$MSG_PAUSE_ERROR_FORMAT"
        fi
        ;; 
    resume)
        if [ -f "$PAUSE_FILE" ]; then
            rm "$PAUSE_FILE"
            echo "$MSG_RESUME_RESUMED"
        else
            echo "$MSG_RESUME_NOT_PAUSED"
        fi
        ;; 
    now)
        echo "$MSG_NOW_TRIGGERING"
        ( _eye_action ) > /dev/null 2>&1 & 
        disown
        ;; 
    status)
        if [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null; then
            _load_config
            printf "$MSG_STATUS_RUNNING\n" "$(cat "$PID_FILE")"
            
            # æ˜¾ç¤ºæš‚åœçŠ¶æ€
            if [ -f "$PAUSE_FILE" ]; then
                pause_until=$(cat "$PAUSE_FILE")
                current=$(date +%s)
                if [ "$current" -lt "$pause_until" ]; then
                    remaining=$((pause_until - current))
                    target_date=$(date -d "@$pause_until" "+%H:%M:%S")
                    printf "$MSG_STATUS_PAUSED_REMAINING\n" "$(_format_duration $remaining)" "$target_date"
                else
                    rm "$PAUSE_FILE" # æ¸…ç†è¿‡æœŸæ–‡ä»¶
                fi
            fi
            
            last=$(cat "$EYE_LOG" 2>/dev/null || date +%s)
            diff=$(( $(date +%s) - last ))
            gap_fmt=$(_format_duration $REST_GAP)
            look_fmt=$(_format_duration $LOOK_AWAY)
            printf "$MSG_STATUS_CONFIG\n" "$gap_fmt" "$look_fmt"
            printf "$MSG_STATUS_LAST_REST\n" "$(_format_duration $diff)"
            printf "$MSG_STATUS_SOUND\n" "$SOUND_START" "$SOUND_END" "$SOUND_SWITCH"
            printf "$MSG_STATUS_LANG\n" "$LANGUAGE"
        else
            echo "$MSG_STATUS_STOPPED"
        fi
        ;; 
    set)
        if [ -z "$2" ]; then
            echo -e "$MSG_SET_USAGE_HINT"
            exit 1
        fi
        
        gap_input=$2
        look_input=$3
        
        _load_config
        
        new_gap=$(_parse_duration "$gap_input")
        [ $? -ne 0 ] && exit 1
        
        if [ -n "$look_input" ]; then
            new_look=$(_parse_duration "$look_input")
            [ $? -ne 0 ] && exit 1
        else
            new_look=$LOOK_AWAY
        fi
        
        REST_GAP=$new_gap
        LOOK_AWAY=$new_look
        _save_config
        
        printf "$MSG_SET_UPDATED\n" "$(_format_duration $REST_GAP)" "$(_format_duration $LOOK_AWAY)"
        ;; 
    language)
        lang_input=$2
        if [[ "$lang_input" == "en" ]] || [[ "$lang_input" == "English" ]]; then
            LANGUAGE="en"
        elif [[ "$lang_input" == "zh" ]] || [[ "$lang_input" == "Chinese" ]]; then
            LANGUAGE="zh"
        else
            echo "$MSG_LANG_INVALID"
            exit 1
        fi
        _save_config
        _init_messages # é‡æ–°åˆå§‹åŒ–ä»¥æ˜¾ç¤ºæ­£ç¡®è¯­è¨€çš„æç¤º
        printf "$MSG_LANG_UPDATED\n" "$LANGUAGE" "$LANGUAGE"
        ;;
    sound)
        shift
        _cmd_sound "$@"
        ;; 
    _action)
        _eye_action
        ;; 
    *)
        _usage
        ;; 
esac
