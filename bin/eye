#!/bin/bash

# Resolve symlink to find the library directory
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# Detect Library Directory (Dev vs Prod)
# Dev: bin/eye -> lib/
# Prod: ~/.local/bin/eye -> ~/.local/lib/eye/
if [ -f "$DIR/../lib/constants.sh" ]; then
    LIB_DIR="$DIR/../lib"
elif [ -d "$HOME/.local/lib/eye" ]; then
    LIB_DIR="$HOME/.local/lib/eye"
else
    echo "Error: Library files not found." >&2
    exit 1
fi

# Load Libraries
source "$LIB_DIR/constants.sh"
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/i18n.sh"
source "$LIB_DIR/config.sh"
source "$LIB_DIR/io.sh"
source "$LIB_DIR/core.sh"
source "$LIB_DIR/providers.sh"
source "$LIB_DIR/sound.sh"
source "$LIB_DIR/daemon.sh"
source "$LIB_DIR/cli.sh"
source "$LIB_DIR/migrate.sh"

# Initialization
_load_global_config
_ensure_default_task
_migrate_v1_to_v2
_init_messages

# Signal Handling
_cleanup() {
    exit 0
}
trap _cleanup SIGINT SIGTERM

# Global Argument Parsing
QUIET_MODE=""
ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -v|--version)
      echo "eye version $EYE_VERSION"
      exit 0
      ;;
    -q|--quiet)
      QUIET_MODE=1
      shift
      ;;
    -h|--help)
      _cmd_usage
      exit 0
      ;;
    *)
      ARGS+=("$1")
      shift
      ;;
  esac
done

# Restore positional parameters
set -- "${ARGS[@]}"

if [[ -z "$1" ]]; then
    # Respect ROOT_CMD setting (trim whitespace)
    CLEAN_ROOT_CMD=$(echo "${ROOT_CMD:-help}" | xargs)
    case "$CLEAN_ROOT_CMD" in
        status) _cmd_status ;;
        *)      _cmd_usage ;;
    esac
    exit 0
fi

CMD=$1
shift

case "$CMD" in
    add)        _cmd_add "$@" ;;
    list)       _cmd_status "$@" ;;
    remove)     _cmd_remove "$@" ;;
    edit)       _cmd_edit "$@" ;;
    in)         _cmd_in "$@" ;;
    start)      _cmd_start "$@" ;;
    stop)       _cmd_stop "$@" ;;
    resume)     _cmd_resume "$@" ;;
    now)        _cmd_now "$@" ;;
    time)       _cmd_time "$@" ;;
    count)      _cmd_count "$@" ;;
    reset)      _cmd_reset "$@" ;;
    daemon)     _cmd_daemon "$@" ;;
    status)     _cmd_status "$@" ;;
    sound)      _cmd_sound "$@" ;;
    help)       _cmd_usage ;;
    version)    _cmd_version ;;
    *)          _cmd_usage ;;
esac
