#!/bin/bash

# =================é…ç½®ä¸è·¯å¾„å®šä¹‰ (XDGå‡†åˆ™)=================
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/eye"
DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/eye"
STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/eye"

CONFIG_FILE="$CONFIG_DIR/config"
CUSTOM_SOUNDS_MAP="$CONFIG_DIR/custom_sounds.map"
EYE_LOG="$STATE_DIR/last_notified"
PID_FILE="$STATE_DIR/daemon.pid"
PAUSE_FILE="$STATE_DIR/pause_until"

# ç¡®ä¿ç›®å½•å­˜åœ¨
mkdir -p "$CONFIG_DIR" "$DATA_DIR/sounds" "$STATE_DIR"

# é»˜è®¤é…ç½®
DEFAULT_REST_GAP=1200
DEFAULT_LOOK_AWAY=20
DEFAULT_SOUND_START="default"
DEFAULT_SOUND_END="complete"
DEFAULT_SOUND_SWITCH="on"

# =================æ ¸å¿ƒåŠŸèƒ½å‡½æ•°=================

# æ—¶é—´è§£æå‡½æ•° (æ”¯æŒ 1h 30m 20s æ ¼å¼)
_parse_duration() {
    local input="$*"
    # ç§»é™¤æ‰€æœ‰ç©ºæ ¼
    input="${input// /}"
    
    # å¦‚æœæ˜¯çº¯æ•°å­—ï¼Œé»˜è®¤ä¸ºç§’
    if [[ "$input" =~ ^[0-9]+$ ]]; then
        echo "$input"
        return
    fi

    local total_seconds=0
    
    # æå–å¤© (d)
    if [[ "$input" =~ ([0-9]+)d ]]; then
        total_seconds=$((total_seconds + ${BASH_REMATCH[1]} * 86400))
    fi
    # æå–å°æ—¶ (h)
    if [[ "$input" =~ ([0-9]+)h ]]; then
        total_seconds=$((total_seconds + ${BASH_REMATCH[1]} * 3600))
    fi
    # æå–åˆ†é’Ÿ (m)
    if [[ "$input" =~ ([0-9]+)m ]]; then
        total_seconds=$((total_seconds + ${BASH_REMATCH[1]} * 60))
    fi
    # æå–ç§’ (s)
    if [[ "$input" =~ ([0-9]+)s ]]; then
        total_seconds=$((total_seconds + ${BASH_REMATCH[1]}))
    fi

    if [ "$total_seconds" -eq 0 ]; then
        echo "Error: Invalid time format" >&2
        return 1
    fi
    
    echo "$total_seconds"
}

# æ ¼å¼åŒ–ç§’æ•°ä¸ºæ˜“è¯»æ ¼å¼
_format_duration() {
    local T=$1
    local D=$((T/60/60/24))
    local H=$((T/60/60%24))
    local M=$((T/60%60))
    local S=$((T%60))
    
    [[ $D -gt 0 ]] && printf '%dd ' $D
    [[ $H -gt 0 ]] && printf '%dh ' $H
    [[ $M -gt 0 ]] && printf '%dm ' $M
    [[ $D -eq 0 && $H -eq 0 && $M -eq 0 ]] && printf '%ds' $S || printf '%ds' $S
}

# åŠ è½½é…ç½®
_load_config() {
    if [ ! -f "$CONFIG_FILE" ]; then
        cat > "$CONFIG_FILE" <<EOF
REST_GAP=$DEFAULT_REST_GAP
LOOK_AWAY=$DEFAULT_LOOK_AWAY
SOUND_START=$DEFAULT_SOUND_START
SOUND_END=$DEFAULT_SOUND_END
SOUND_SWITCH=$DEFAULT_SOUND_SWITCH
EOF
    fi
    source "$CONFIG_FILE"
    [ -f "$CUSTOM_SOUNDS_MAP" ] && source "$CUSTOM_SOUNDS_MAP"
}

# ä¿å­˜åŸºç¡€é…ç½®
_save_config() {
    cat > "$CONFIG_FILE" <<EOF
REST_GAP=${REST_GAP:-$DEFAULT_REST_GAP}
LOOK_AWAY=${LOOK_AWAY:-$DEFAULT_LOOK_AWAY}
SOUND_START=${SOUND_START:-$DEFAULT_SOUND_START}
SOUND_END=${SOUND_END:-$DEFAULT_SOUND_END}
SOUND_SWITCH=${SOUND_SWITCH:-$DEFAULT_SOUND_SWITCH}
EOF
}

# è·å–éŸ³æ•ˆè·¯å¾„
_get_sound_path() {
    local tag=$1
    local path=""
    
    case "$tag" in
        "none")      echo "NONE"; return ;; 
        "default")   path="/usr/share/sounds/freedesktop/stereo/message.oga" ;; 
        "bell")      path="/usr/share/sounds/freedesktop/stereo/bell.oga" ;; 
        "complete")  path="/usr/share/sounds/freedesktop/stereo/complete.oga" ;; 
        "success")   path="/usr/share/sounds/freedesktop/stereo/service-login.oga" ;; 
        "alarm")     path="/usr/share/sounds/freedesktop/stereo/alarm-clock-elapsed.oga" ;; 
        "camera")    path="/usr/share/sounds/freedesktop/stereo/camera-shutter.oga" ;; 
        "device")    path="/usr/share/sounds/freedesktop/stereo/device-added.oga" ;; 
        "attention") path="/usr/share/sounds/freedesktop/stereo/window-attention.oga" ;; 
        *)
            local custom_var="SOUND_PATH_${tag}"
            path="${!custom_var}" 
            ;; 
    esac

    if [ ! -f "$path" ]; then
         path="/usr/share/sounds/freedesktop/stereo/message.oga"
    fi
    echo "$path"
}

_play() {
    [ "$SOUND_SWITCH" != "on" ] && return
    local tag=$1
    local file=$(_get_sound_path "$tag")
    
    if [ "$file" == "NONE" ]; then
        return
    elif [ -f "$file" ] && command -v paplay > /dev/null; then
        paplay "$file" > /dev/null 2>&1 &
    fi
}

_eye_action() {
    _load_config
    notify-send -i appointment-soon -t 5000 "ğŸ‘€ æŠ¤çœ¼æ—¶é—´" "å¼€å§‹è¿œçœº $(_format_duration ${LOOK_AWAY})ï¼"
    _play "$SOUND_START"
    
    sleep "$LOOK_AWAY"
    
    notify-send -i emblem-success -t 3000 "âœ… è¿œçœºç»“æŸ" "çœ¼ç›ä¼‘æ¯å¥½äº†ï¼Œç»§ç»­åŠ æ²¹å§ï¼"
    _play "$SOUND_END"
    
    date +%s > "$EYE_LOG"
}

# =================å‘½ä»¤å¤„ç†é€»è¾‘=================

_usage() {
    cat <<EOF
ç”¨æ³•: eye <command> [args]

æ ¸å¿ƒå‘½ä»¤:
  start            å¯åŠ¨æŠ¤çœ¼åå°è¿›ç¨‹
  stop             åœæ­¢æŠ¤çœ¼è¿›ç¨‹
  pause <time>     æš‚åœæŠ¤çœ¼æ¨¡å¼æŒ‡å®šæ—¶é•¿ (ä¾‹å¦‚: 1h, 30m, 1h30m)
  resume           å–æ¶ˆæš‚åœï¼Œç«‹å³æ¢å¤
  status           æŸ¥çœ‹å½“å‰çŠ¶æ€
  now              ç«‹å³æ‰§è¡Œä¸€æ¬¡æŠ¤çœ¼æé†’
  set <gap> <look> è®¾ç½®æ—¶é—´é—´éš”å’Œè¿œçœºæ—¶é•¿ (æ”¯æŒå•ä½ s, m, h)
                   ä¾‹å¦‚: eye set 20m 20s

éŸ³é¢‘ç®¡ç† (eye sound ...):
  sound list              åˆ—å‡ºæ‰€æœ‰å¯ç”¨éŸ³æ•ˆ
  sound play <tag>        è¯•å¬æŒ‡å®šæ ‡ç­¾çš„éŸ³æ•ˆ
  sound set <start> <end> è®¾ç½®å¼€å§‹å’Œç»“æŸçš„æç¤ºéŸ³
  sound add <tag> <path>  æ·»åŠ è‡ªå®šä¹‰éŸ³é¢‘æ–‡ä»¶
  sound rm  <tag>         åˆ é™¤è‡ªå®šä¹‰éŸ³æ•ˆ
  sound on|off            å…¨å±€å¼€å¯æˆ–å…³é—­å£°éŸ³

EOF
}

_cmd_sound() {
    local subcmd=$1
    shift
    _load_config

    case "$subcmd" in
        list)
            echo "ğŸµ å¯ç”¨éŸ³æ•ˆåˆ—è¡¨ï¼š"
            echo "  [å†…ç½®] (ä¸å¯åˆ é™¤)"
            echo "  - none      : é™éŸ³"
            echo "  - default   : æ ‡å‡†é€šçŸ¥"
            echo "  - bell      : æ¸…è„†é“ƒå£°"
            echo "  - complete  : ä»»åŠ¡å®Œæˆ"
            echo "  - success   : æˆåŠŸéŸ³"
            echo "  - alarm     : é—¹é’Ÿ"
            echo "  - camera    : å¿«é—¨å£°"
            echo "  - device    : è®¾å¤‡æ¥å…¥"
            echo "  - attention : æç¤ºéŸ³"
            
            echo "  [è‡ªå®šä¹‰]"
            local has_custom=0
            if [ -f "$CUSTOM_SOUNDS_MAP" ]; then
                while IFS='=' read -r key value; do
                    if [[ $key == SOUND_PATH_* ]]; then
                        tag=${key#SOUND_PATH_}
                        echo "  - $tag : $value"
                        has_custom=1
                    fi
                done < "$CUSTOM_SOUNDS_MAP"
            fi
            [ $has_custom -eq 0 ] && echo "  (æ— )"
            ;; 
        play)
            local tag=$1
            [ -z "$tag" ] && { echo "âŒ è¯·æŒ‡å®šæ ‡ç­¾"; return 1; }
            local path=$(_get_sound_path "$tag")
            echo "â–¶ï¸  è¯•å¬ [$tag] : $path"
            if [ -f "$path" ]; then
                command -v paplay >/dev/null && paplay "$path"
            elif [ "$tag" == "none" ]; then
                echo "ğŸ”‡ (é™éŸ³)"
            else
                echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•æ’­æ”¾"
            fi
            ;; 
        set)
            local s1=${1:-$SOUND_START}
            local s2=${2:-$SOUND_END}
            SOUND_START=$s1
            SOUND_END=$s2
            _save_config
            echo "âœ… éŸ³æ•ˆå·²æ›´æ–°: å¼€å§‹[$s1] -> ç»“æŸ[$s2]"
            ;; 
        add)
            local tag=$1
            local path=$2
            if [ -z "$tag" ] || [ -z "$path" ]; then
                echo "âŒ ç”¨æ³•: eye sound add <tag> <path>"
                return 1
            fi
            if [[ " none default bell complete success alarm camera device attention " =~ " $tag " ]]; then
                 echo "âŒ é”™è¯¯: '$tag' æ˜¯å†…ç½®éŸ³æ•ˆï¼Œæ— æ³•è¦†ç›–ã€‚"
                 return 1
            fi
            if [ ! -f "$path" ]; then
                echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: $path"
                return 1
            fi
            if grep -q "SOUND_PATH_${tag}=" "$CUSTOM_SOUNDS_MAP" 2>/dev/null; then
                read -p "âš ï¸  æ ‡ç­¾ '$tag' å·²å­˜åœ¨ï¼Œæ˜¯å¦æ›¿æ¢ï¼Ÿ[y/N] " choice
                [[ "$choice" != "y" && "$choice" != "Y" ]] && return
            fi
            local abs_path=$(readlink -f "$path")
            [ -f "$CUSTOM_SOUNDS_MAP" ] && sed -i "/SOUND_PATH_${tag}=/d" "$CUSTOM_SOUNDS_MAP"
            echo "SOUND_PATH_${tag}=\"${abs_path}\"" >> "$CUSTOM_SOUNDS_MAP"
            echo "âœ… å·²æ·»åŠ : $tag"
            ;; 
        rm)
            local tag=$1
            if [ -z "$tag" ]; then
                echo "âŒ ç”¨æ³•: eye sound rm <tag>"
                return 1
            fi
            if [[ " none default bell complete success alarm camera device attention " =~ " $tag " ]]; then
                 echo "âŒ é”™è¯¯: '$tag' æ˜¯å†…ç½®éŸ³æ•ˆï¼Œä¸èƒ½åˆ é™¤ã€‚"
                 return 1
            fi
            if [ -f "$CUSTOM_SOUNDS_MAP" ]; then
                if grep -q "SOUND_PATH_${tag}=" "$CUSTOM_SOUNDS_MAP"; then
                    sed -i "/SOUND_PATH_${tag}=/d" "$CUSTOM_SOUNDS_MAP"
                    echo "ğŸ—‘ï¸  å·²åˆ é™¤éŸ³æ•ˆ: $tag"
                else
                    echo "âš ï¸  æœªæ‰¾åˆ°è‡ªå®šä¹‰æ ‡ç­¾: $tag"
                fi
            else
                echo "âš ï¸  æš‚æ— è‡ªå®šä¹‰é…ç½®"
            fi
            ;; 
        on)
            SOUND_SWITCH="on"; _save_config; echo "ğŸ”Š å£°éŸ³å·²å¼€å¯" ;; 
        off)
            SOUND_SWITCH="off"; _save_config; echo "ğŸ”‡ å£°éŸ³å·²å…³é—­" ;; 
        *)
            echo "ç”¨æ³•: eye sound [list|play|set|add|rm|on|off]" ;; 
    esac
}
# =================ä¸»ç¨‹åºå…¥å£=================

# å¤„ç† --help
if [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]] || [[ -z "$1" ]]; then
    _usage
    exit 0
fi

case "$1" in
    start)
        if [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null; then
            echo "âš ï¸  æŠ¤çœ¼æ¨¡å¼å·²åœ¨è¿è¡Œä¸­ (PID: $(cat "$PID_FILE"))"
        else
            (
                echo $BASHPID > "$PID_FILE"
                date +%s > "$EYE_LOG"
                while true; do
                    _load_config
                    current_time=$(date +%s)
                    
                    # æ£€æŸ¥æ˜¯å¦æš‚åœ
                    if [ -f "$PAUSE_FILE" ]; then
                        pause_until=$(cat "$PAUSE_FILE")
                        if [ "$current_time" -lt "$pause_until" ]; then
                             sleep 5
                             continue
                        else
                             rm "$PAUSE_FILE" # æš‚åœè¿‡æœŸ
                        fi
                    fi

                    last_time=$(cat "$EYE_LOG" 2>/dev/null || date +%s)
                    if [ $((current_time - last_time)) -ge $REST_GAP ]; then
                         _eye_action &
                         wait $!
                    fi
                    sleep 5
                done
            ) > /dev/null 2>&1 &
            disown
            echo "âœ… æŠ¤çœ¼æ¨¡å¼å·²å¯åŠ¨"
        fi
        ;; 
    stop)
        if [ -f "$PID_FILE" ]; then
            pkill -P $(cat "$PID_FILE") >/dev/null 2>&1
            kill $(cat "$PID_FILE") >/dev/null 2>&1
            rm "$PID_FILE" 2>/dev/null
            rm "$PAUSE_FILE" 2>/dev/null
            echo "ğŸ›‘ å·²åœæ­¢"
        else
            echo "âš ï¸  æœªè¿è¡Œ"
        fi
        ;; 
    pause)
        duration_str="$*"
        [ -z "$duration_str" ] && { echo "âŒ è¯·æŒ‡å®šæ—¶é•¿ (å¦‚ 1h, 30m)"; exit 1; }
        seconds=$(_parse_duration "$duration_str")
        if [ $? -eq 0 ]; then
            target_time=$(( $(date +%s) + seconds ))
            echo "$target_time" > "$PAUSE_FILE"
            formatted_dur=$(_format_duration "$seconds")
            target_date=$(date -d "@$target_time" "+%H:%M:%S")
            echo "â¸ï¸  æŠ¤çœ¼æ¨¡å¼æš‚åœ $formatted_dur (ç›´åˆ° $target_date)"
        else
             echo "âŒ æ ¼å¼é”™è¯¯ã€‚ç¤ºä¾‹: 1h, 30m, 10s"
        fi
        ;; 
    resume)
        if [ -f "$PAUSE_FILE" ]; then
            rm "$PAUSE_FILE"
            echo "â–¶ï¸  æš‚åœå·²å–æ¶ˆï¼Œæ¢å¤è¿è¡Œ"
        else
            echo "âš ï¸  å½“å‰æœªå¤„äºæš‚åœçŠ¶æ€"
        fi
        ;; 
    now)
        echo "ğŸ”„ æ­£åœ¨è§¦å‘è¿œçœº..."
        ( _eye_action ) > /dev/null 2>&1 & 
        disown
        ;; 
    status)
        if [ -f "$PID_FILE" ] && kill -0 $(cat "$PID_FILE") 2>/dev/null; then
            _load_config
            echo "ğŸŸ¢ è¿è¡Œä¸­ | PID: $(cat "$PID_FILE")"
            
            # æ˜¾ç¤ºæš‚åœçŠ¶æ€
            if [ -f "$PAUSE_FILE" ]; then
                pause_until=$(cat "$PAUSE_FILE")
                current=$(date +%s)
                if [ "$current" -lt "$pause_until" ]; then
                    remaining=$((pause_until - current))
                    target_date=$(date -d "@$pause_until" "+%H:%M:%S")
                    echo "â¸ï¸  [å·²æš‚åœ] å‰©ä½™: $(_format_duration $remaining) (ç›´åˆ° $target_date)"
                else
                    rm "$PAUSE_FILE" # æ¸…ç†è¿‡æœŸæ–‡ä»¶
                fi
            fi
            
            last=$(cat "$EYE_LOG" 2>/dev/null || date +%s)
            diff=$(( $(date +%s) - last ))
            gap_fmt=$(_format_duration $REST_GAP)
            look_fmt=$(_format_duration $LOOK_AWAY)
            echo "âš™ï¸  é…ç½®: ${gap_fmt} é—´éš” / ${look_fmt} è¿œçœº"
            echo "â±ï¸  ä¸Šæ¬¡ä¼‘æ¯: $(_format_duration $diff) å‰"
            echo "ğŸ”Š éŸ³æ•ˆ: [$SOUND_START] -> [$SOUND_END] (å¼€å…³: $SOUND_SWITCH)"
        else
            echo "ğŸ”´ å·²åœæ­¢"
        fi
        ;; 
    set)
        if [ -z "$2" ]; then
            echo "ç”¨æ³•: eye set <é—´éš”> <æ—¶é•¿>"
            echo "ç¤ºä¾‹: eye set 20m 20s"
            exit 1
        fi
        
        # æå–å‚æ•°
        # å‡è®¾ $2 æ˜¯ç¬¬ä¸€ä¸ªæ—¶é—´å‚æ•°ï¼Œ$3 æ˜¯ç¬¬äºŒä¸ª(å¯é€‰ï¼Œé»˜è®¤ä¸ºæ—§å€¼)
        # ä½†æ˜¯è¿™é‡Œç”¨æˆ·å¯èƒ½è¾“å…¥ "eye set 20m 20s"ï¼Œ$2=20m, $3=20s
        # ç”¨æˆ·ä¹Ÿå¯èƒ½è¾“å…¥ "eye set 1h30m 30s"
        
        gap_input=$2
        look_input=$3
        
        _load_config
        
        # è§£æé—´éš”
        new_gap=$(_parse_duration "$gap_input")
        [ $? -ne 0 ] && exit 1
        
        # è§£ææ—¶é•¿ (å¦‚æœæœªæä¾›ï¼Œä¿æŒåŸæ ·ï¼Œæˆ–è€…ä»é…ç½®ä¸­è¯»å–)
        if [ -n "$look_input" ]; then
            new_look=$(_parse_duration "$look_input")
            [ $? -ne 0 ] && exit 1
        else
            new_look=$LOOK_AWAY
        fi
        
        REST_GAP=$new_gap
        LOOK_AWAY=$new_look
        _save_config
        
        echo "âœ… é…ç½®å·²æ›´æ–°: é—´éš” $(_format_duration $REST_GAP), è¿œçœº $(_format_duration $LOOK_AWAY)"
        ;; 
    sound)
        shift
        _cmd_sound "$@"
        ;; 
    _action)
        _eye_action
        ;; 
    *)
        _usage
        ;; 
esac
