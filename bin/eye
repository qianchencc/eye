#!/bin/bash

# Resolve symlink to find the library directory
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"

# Detect Library Directory (Dev vs Prod)
# Dev: bin/eye -> lib/
# Prod: ~/.local/bin/eye -> ~/.local/lib/eye/
if [ -f "$DIR/../lib/constants.sh" ]; then
    LIB_DIR="$DIR/../lib"
elif [ -d "$HOME/.local/lib/eye" ]; then
    LIB_DIR="$HOME/.local/lib/eye"
else
    echo "Error: Library files not found." >&2
    exit 1
fi

# Load Libraries
source "$LIB_DIR/constants.sh"
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/i18n.sh"
source "$LIB_DIR/config.sh"
source "$LIB_DIR/sound.sh"
source "$LIB_DIR/daemon.sh"
source "$LIB_DIR/cli.sh"

# Initialization
_load_config
_init_messages

# Argument Handling
if [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]] || [[ -z "$1" ]]; then
    _cmd_usage
    exit 0
fi

CMD=$1
shift

case "$CMD" in
    start)      _cmd_start ;;
    stop)       _cmd_stop ;;
    kill)       _cmd_kill ;;
    daemon)     _daemon_loop ;;
    pause)      _cmd_pause "$@" ;;
    pass)       _cmd_pass "$@" ;;
    resume)     _cmd_resume ;;
    now)        _cmd_now "$@" ;;
    status)     _cmd_status ;;
    set)        _cmd_set "$@" ;;
    language)   _cmd_language "$@" ;;
    autostart)  _cmd_autostart "$@" ;;
    sound)      _cmd_sound "$@" ;;
    help)       _cmd_usage ;;
    _action)    _eye_action ;; # Internal use
    *)          _cmd_usage ;;
esac